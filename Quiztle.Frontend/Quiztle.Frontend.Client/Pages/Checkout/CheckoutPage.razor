@page "/Checkout"
@inject HttpClient Http
@inject NavigationManager NavigationManager
@using System.Net.Http.Json
@using System.Text.Json
@rendermode InteractiveAuto

<h3>CheckoutPage</h3>

<button @onclick="() => RedirectToCheckout(_price1)">
    Monthly
</button>

<button @onclick="() => RedirectToCheckout(_price2)">
    Yearly
</button>

@code {
    private string _price1 = "price_1QAsz5LKiSsrfvcHuQ3axi41";
    private string _price2 = "price_1QAszZLKiSsrfvcHQyUDjoBx";

    private async Task RedirectToCheckout(string priceId)
    {
        var checkoutRequest = new
        {
            PriceId = priceId,
            Quantity = 1, // Define a default quantity, you can make this dynamic
            SuccessUrl = NavigationManager.BaseUri + "success",
            CancelUrl = NavigationManager.BaseUri + "cancel",
            CustomerId = "cus_R34iUkfYZddKau"
        };

        var response = await Http.PostAsJsonAsync("api/webhooks/stripe/create-checkout-session", checkoutRequest);

        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<JsonElement>();
            if (result.TryGetProperty("sessionId", out JsonElement sessionIdElement))
            {
                string sessionId = sessionIdElement.GetString()!;
                var stripeUrl = $"https://checkout.stripe.com/pay/{sessionId}";
                NavigationManager.NavigateTo(stripeUrl, true);
            }
            else
            {
                Console.WriteLine("Error retrieving the session ID.");
            }
        }
        else
        {
            Console.WriteLine("Error creating the checkout session.");
        }
    }
}
