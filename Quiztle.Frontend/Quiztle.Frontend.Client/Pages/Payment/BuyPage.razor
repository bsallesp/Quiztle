@page "/Buy"
@page "/Buy/{priceId}"

@using Microsoft.AspNetCore.Authorization
@using Quiztle.Frontend.Client.APIServices.StripeService

@inject StripeSessionsService StripePaymentService
@inject StripeCustomerService StripeCustomerService
@inject GetUserInfos GetUserInfos

@attribute [Authorize]

@code {
    [Parameter]
    public string priceId { get; set; } = "";

    protected override async Task OnParametersSetAsync()
    {
        if (string.IsNullOrEmpty(priceId)) Nav.NavigateTo("/");

        var claims = await GetUserInfos.GetUserNameAndEmail();
        if (string.IsNullOrEmpty(claims["Email"])) Nav.NavigateTo("/error", true);

        Console.WriteLine("EMAIL????????????????" + claims["Email"]);

        var customerId = await StripeCustomerService.SearchCustomerIdByEmail(claims["Email"]);

        if(string.IsNullOrEmpty(customerId))
        customerId = await StripeCustomerService.CreateCustomer(claims["Name"] ?? "", claims["Email"]);

        var session = await StripePaymentService.CreateSession(priceId, customerId, claims["Email"]);

        Console.WriteLine(session);
        
    }

    // protected override async Task OnInitializedAsync()
    // {

    // }
}
